
from datetime import datetime
import string
from flask import Blueprint, Response, request
from pymongo import results
from Database.database import get_exploit_cve, get_pocs_with_id, reconnaissance
from api.v1.output import make_output
from Library.Exploit.POCURI import POCURI
Poc = Blueprint('Poc', __name__)
import xml.etree.ElementTree as ET
from threading import Thread
from Library.Target.target import Target, get_target_url
from Library.Exploit.runpoc import run_scan
from Library.Reconnai.reconnaissance import Reconnaissance
from Tools.ToolExploit.openport import openport
@Poc.route('/listpocs', methods=['GET'])
def get_all_tools():
    CPOC = POCURI()
    result = CPOC.get_all_pocs()    
    if not isinstance(result, str):
        return Response(make_output(data = result, message ='success'), mimetype="application/json", status=200)
    else:
        return Response(make_output(message =  "fail", data= result ), mimetype="application/json", status=404)


@Poc.route('/get', methods=['GET'])
def get_answer_poc():
    data_filter = {}
    if ("target_id" in request.args):
        data_filter['target_id'] = request.args['target_id']
    [status, data] = get_exploit_cve(data_filter)
    result = []
    for i in range(data.count()):
        temp = data[i];
        temp['_id'] = str(temp['_id'])
        add_new = True
        for j  in range(len(result)):
            check_duplicate = result[j]
            if temp['app_name'] == check_duplicate['app_name']:
                if temp['date_check'] > check_duplicate['date_check']: 
                    result[j] = temp
                else: add_new = False
        if add_new: result.append(temp)

    if status:
        return Response(make_output(data = result, message ='success'), mimetype="application/json", status=200)
    else:
        return Response(make_output(message =  "fail", data= result ), mimetype="application/json", status=404)

@Poc.route('/getall', methods=['GET'])
def get_all_answer_poc():
    [status, data] = get_exploit_cve({})
    result = []
    for i in range(data.count()):
        temp = data[i];
        temp['_id'] = str(temp['_id'])
        result.append(temp)
    if status:
        return Response(make_output(data = result, message ='success'), mimetype="application/json", status=200)
    else:
        return Response(make_output(message =  "fail", data= result ), mimetype="application/json", status=404)



def checkpoc_run(recon, pocs):
    
    check_pocs = run_scan(recon = recon, pocenable = pocs)
    check_pocs.run()

global checkpoc_running 
checkpoc_running = []

@Poc.route('/start', methods=['PUT'])
def request_put_runpoc():
    recon_id = request.form['recon_id']
    if 'pocrun' in request.form:
        run_pocs = request.form['pocrun']
    else: 
        run_pocs = '*telerik_cve_2019_18935*'
    global checkpoc_running
    recon = Reconnaissance()
    status = recon.update_reconid(recon_id)
    if status :
        runthread = Thread(target=checkpoc_run, args=(recon, run_pocs, ))
        runthread.start()
        checkpoc_running.append({"thread": runthread, "recon_id": recon_id, "date": datetime.now().strftime("%d/%m/%Y %H:%M:%S") })
        return Response(make_output(data = "start check poc susscess", message ='success'), mimetype="application/json", status=200)
    else:
        return Response(make_output(message =  "fail", data= str(status) ), mimetype="application/json", status=404)

@Poc.route('/status', methods=['GET'])
def request_status_runpoc():
    global checkpoc_running
    result = []
    
    for run in checkpoc_running:
        if run['thread'].isAlive():
            result.append({'recon_id': run['recon_id'], 'date' : run['date'], "status" : "running"})
        else:
            result.append({'recon_id': run['recon_id'], 'date' : run['date'], "status" : "success"})
    if len(result) :
        return Response(make_output(data = result, message ='success'), mimetype="application/json", status=200)
    else:
        return Response(make_output(message =  "fail", data= "No data" ), mimetype="application/json", status=404)
