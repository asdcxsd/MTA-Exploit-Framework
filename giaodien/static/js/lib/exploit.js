"use strict"; 
var Recon_input; 
var exploit_id; 
$(document).ready(function(){
    renderReconDataOption();
    var activeTab = window.location.hash;
    if(activeTab.includes("~")){
        var temp = activeTab.split("~"); 
        $(temp[0])[0].click();
        renderExploitDetailModal(temp[1]); 
    }else{
        $( activeTab )[0].click();
    }
})

function renderReconDataOption(){
    $.ajax({
        type: "GET", 
        url : "/getallrecon", 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp)=>{
        if(resp['message'] == "success"){
            var listRecon = resp['data']
            $("#exploitInput").append($("<option>").html(''));
            for(var i = 0; i < listRecon.length; i++){
                var recon = listRecon[i]; 
                var option = $("<option>"); 
                option.attr('id', recon['_id']); 
                option.text(recon['target_ip'] + "  ("+recon['date_end']+")"); 
                $("#exploitInput").append(option);
            }
        }
    })
}
$("#exploitInput").on("click","option",function(){
    var option = $(this); 
    if(option.text() == ""){
        Recon_input = ""; 
        $(".dropdown-text-input").text("Chọn kết quả TTTT"); 
    }else{
        Recon_input = $(this).attr("id"); 
        $(".dropdown-text-input").text(option.text()); 
    }
    
})
$("#exploitManagerTab").on('click', function(){
    $.ajax({
        type: "GET", 
        url : "/getallexploit", 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) =>{
        if(resp['message'] == 'success'){
            $("#exploitResultManagerTable").DataTable().clear().destroy();
            $("#exploitResultManagerTable").DataTable({
                data: resp['data'],
                "language": {
                "search": "Tìm kiếm ", 
                "emptyTable": "Không có dữ liệu hiển thị", 
                "info": "Hiển thị trang _PAGE_/_PAGES_", 
                "infoEmpty": "Hiển thị trang 0/0", 
                "lengthMenu": "Hiển thị _MENU_ hàng", 
                "paginate": {
                    "previous": "Trang trước", 
                    'next': "Trang sau", 
                }
                }, 
                "autoWidth": false,
                rowId: '_id', 
                columns: [
                    { data: "target_ip" },
                    { data: "date_start" },
                    { data: "date_end" }, 
                    {
                    className: "dt-center editor-delete",
                    defaultContent: '<button id="exploitDetail" class="btn btn-primary">Chi tiết</button><button id="exploitDelete" class="btn btn-danger ml-3" >Xóa</button>',
                    orderable: false
                    }
                ]
            })
        }
    })
})
function renderExploitDetailModal(exploit_id){
    $.ajax({
        type: "POST", 
        url : "/getexploitdetail", 
        data:{"exploit_id": exploit_id}, 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) =>{
        if(resp['message'] == 'success'){
            var list_cve = resp['data']['EXPLOIT_POCS']; 
            $("#VulDetailTableBody").html(''); 
            for(var i=0; i< list_cve.length; i++){
                var cve = list_cve[i]; 
                var row = $("<tr>"); 
                row.append($("<td>").text(cve['app_name'])); 
                row.append($("<td>").text(cve['created']));
                row.append($("<td>").jsonPresenter({
                    json: cve['result']
                  })); 
                row.append($("<td>").html('<button id="exploitShell" class="btn btn-danger ml-3" >Khai thác</button>'));
                $("#VulDetailTableBody").append(row); 


            }
            $("#VulDetailModal").modal("show"); 
        }
    })
}

$("#exploitResultManagerTable").on('click', "#exploitDetail", function(e){
    var row = $(e.currentTarget).closest('tr'); 
    exploit_id = row.attr('id');
    renderExploitDetailModal(exploit_id); 
})

$("#StartExploit").on('click', function(){
    var Module_Recon = Recon_input; 
    if(Module_Recon == "" || typeof Module_Recon === "undefined"){
        swal("Bạn chưa chọn kết quả thu thập thông tin!", {
            icon: "error",
          });
    }else{
        var module = []; 
        module[0] = "PocCheck"; 
        $.ajax({
            type: "POST", 
            url : "/run", 
            data : {"Module_Reconnaissance":Module_Recon, "Module":module}, 
            beforeSend: (request) =>{
              request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
            }
        })
        .done((resp)=>{
            if(resp['message'] == "success"){
                window.location.href = "/start"; 
            }else{
                new Noty({
                    type: 'error', 
                    layout: 'topRight',
                    theme: 'bootstrap-v4', 
                    text: 'Có lỗi xảy ra, hãy thử lại!', 
                    timeout: 1500, 
                    progressBar: false,
                }).show();
            }
        })
    }
})

$("#VulDetailTable").on('click',"#exploitShell", function(e){
    var row = $(e.currentTarget).closest('tr'); 
    var POC = row.find("td:first-child").text(); 
    $.ajax({
        type: "POST", 
        url : "/runshell", 
        data:{"POC": POC, "Module_Exploit": exploit_id}, 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) =>{
        if(resp['message'] == "success"){
            var process_id = resp['data']['_id']
            window.location.href = "/shell#" + process_id; 
        }
    })
})