"use strict"; 
$(document).ready(function(){
    var activeTab = window.location.hash;
    if(activeTab.includes("~")){
        var temp = activeTab.split("~"); 
        $(temp[0])[0].click();
        renderExploitDetailModal(temp[1]); 
    }else{
        $( activeTab )[0].click();
    }
})
$("#exploitManagerTab").on('click', function(){
    $.ajax({
        type: "GET", 
        url : "/getallexploit", 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) =>{
        if(resp['message'] == 'success'){
            $("#exploitResultManagerTable").DataTable().clear().destroy();
            $("#exploitResultManagerTable").DataTable({
                data: resp['data'],
                "language": {
                "search": "Tìm kiếm ", 
                "emptyTable": "Không có dữ liệu hiển thị", 
                "info": "Hiển thị trang _PAGE_/_PAGES_", 
                "infoEmpty": "Hiển thị trang 0/0", 
                "lengthMenu": "Hiển thị _MENU_ hàng", 
                "paginate": {
                    "previous": "Trang trước", 
                    'next': "Trang sau", 
                }
                }, 
                "autoWidth": false,
                rowId: '_id_process', 
                columns: [
                    { data: "target_ip" },
                    { data: "date_start" },
                    { data: "date_end" }, 
                    {
                    className: "dt-center editor-delete",
                    defaultContent: '<button id="exploitDetail" class="btn btn-primary">Chi tiết</button><button id="exploitDelete" class="btn btn-danger ml-3" >Xóa</button>',
                    orderable: false
                    }
                ]
            })
        }
    })
})
function renderExploitDetailModal(process_id){
    $.ajax({
        type: "POST", 
        url : "/getexploitdetail", 
        data:{"process_id": process_id}, 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) =>{
        if(resp['message'] == 'success'){
            var list_cve = resp['data']['EXPLOIT_POCS']; 
            $("#VulDetailTableBody").html(''); 
            for(var i=0; i< list_cve.length; i++){
                var cve = list_cve[i]; 
                var row = $("<tr>"); 
                row.append($("<td>").text(cve['app_name'])); 
                row.append($("<td>").text(cve['created']));
                row.append($("<td>").jsonPresenter({
                    json: cve['result']
                  })); 
                row.append($("<td>").html('<button id="exploitShell" class="btn btn-danger ml-3" >Khai thác</button>'));
                $("#VulDetailTableBody").append(row); 


            }
            $("#VulDetailModal").modal("show"); 
        }
    })
}

$("#exploitResultManagerTable").on('click', "#exploitDetail", function(e){
    var row = $(e.currentTarget).closest('tr'); 
    var process_id = row.attr('id');
    renderExploitDetailModal(process_id); 
})