'use strict';
$(document).ready(function(){
    checkAuthenOption(); 
    checkCustomOption();
    renderProcessPage();

    getStatusFromServer(); 
}); 
function renderProcessPage(){
    $.ajax({
        type: "GET", 
        url : "/getallstatus", 
        beforeSend: (request) =>{
          request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp)=>{
        if(resp['message'] == 'success'){
            $("#processManagerTable").DataTable().clear().destroy();
            $("#processManagerTable").DataTable({
              data: resp['data'],
              "language": {
                "search": "Tìm kiếm ", 
                "emptyTable": "Không có dữ liệu hiển thị", 
                "info": "Hiển thị trang _PAGE_/_PAGES_", 
                "infoEmpty": "Hiển thị trang 0/0", 
                "lengthMenu": "Hiển thị _MENU_ hàng", 
                "paginate": {
                  "previous": "Trang trước", 
                  'next': "Trang sau", 
                }
              }, 
              "autoWidth": false,
              rowId: '_id', 
              columns: [
                  { data: "Target" },
                  { data: "Date_Create" }, 
                  { data: "Status", 
                  "render": function(data, row, type){
                      if(data == "StatusRunning"){
                          return `<div class="row" style="display: flex; align-items: center;"><div class="col-md-3" style="padding-left: 11%">
                          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="background:white; display: block; shape-rendering: auto;" width="50px" height="50px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
                          <circle cx="50" cy="50" r="32" stroke-width="8" stroke="#07abcc" stroke-dasharray="50.26548245743669 50.26548245743669" fill="none" stroke-linecap="round">
                            <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" keyTimes="0;1" values="0 50 50;360 50 50"></animateTransform>
                          </circle>
                          <!-- [ldio] generated by https://loading.io/ --></svg></div><div class="col-md-9"><span className="custom-input vertical-align">Đang chạy</span></div></div>`; 
                      }
                      if(data == "StatusSuccess"){
                          return `<div class="row" style="display: flex; align-items: center;"><div class="col-md-3">
                          <img src="/static/img/success.gif" style="height: 70px; width: 93px;"/></div><div class="col-md-9"><span className="custom-input vertical-align">Hoàn tất</span></div></div>`;
                      }
                  }
                  },
                  {
                    className: "dt-center editor-delete",
                    defaultContent: '<button id="ViewResult" class="btn btn-primary">Xem kết quả</button><button id="KillProcess" class="btn btn-danger ml-3" >Xóa</button>',
                    orderable: false
                  }
              ]
            })
        }
    })
}

function getStatusFromServer(){
    var source = new EventSource('/getallstatusrunning'); 
    source.onmessage = function(event){
        var data = event.data ; 
        var i; 
        var process_table = $("#processManagerTable").DataTable(); 
        if(data.search("StatusRunning") != -1){
            data = JSON.parse(data); 
            if(data['message'] == "success"){
                var list_status = data['data']; 
                for(i=0; i < list_status.length; i++){
                    var status = list_status[i]; 
                    if(status['Status'] == 'StatusRunning'){
                        continue; 
                    }else{
                        var row_success_id = process_table.row('[id=' +status['_id'] +']').index(); 
                        var row_success_id_real_status = process_table.cell({row: row_success_id, column:2}).data(); 
                        if(row_success_id_real_status == "StatusRunning"){
                            var data_update =  `<div class="row" style="display: flex; align-items: center;"><div class="col-md-3">
                            <img src="/static/img/success.gif" style="height: 70px; width: 93px;"/></div><div class="col-md-9"><span className="custom-input vertical-align">Hoàn tất</span></div></div>`; 
                            process_table.cell({row: row_success_id, column:2}).render(data_update); 
                            process_table.cell({row: row_success_id, column:2}).data("StatusSuccess"); 
                        }

                    }
                }

            }
            
        }else{
            var row_count = process_table.rows().count(); 
            for(i = 0; i< row_count; i++){
                var row_success_id_real_status = process_table.cell({row: i, column:2}).data(); 
                if(row_success_id_real_status == "StatusRunning"){
                    var data_update =  `<div class="row" style="display: flex; align-items: center;"><div class="col-md-3">
                    <img src="/static/img/success.gif" style="height: 70px; width: 93px;"/></div><div class="col-md-9"><span className="custom-input vertical-align">Hoàn tất</span></div></div>`; 
                    process_table.cell({row: i, column:2}).render(data_update); 
                    process_table.cell({row: i, column:2}).data("StatusSuccess");
                }

            }
            source.close(); 
        }
        
    }
}
function checkAuthenOption(){
    if($("#authencheckbox").is(":checked")){
        $(".accountdiv").show(); 
    }else{
        $(".accountdiv").hide(); 
    }
}
function checkCustomOption(){
    if($("#autocheckbox").is(":checked")){
        $(".custompocdiv").show(); 
    }else{
        $(".custompocdiv").hide(); 
    }
}

function redrawTargetModal(){
    $.ajax({
        type: "GET", 
        url : "/getalltarget", 
        beforeSend: (request) =>{
          request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp) => {
        if(resp['message'] == 'success'){
            $("#addTargetTable").DataTable().clear().destroy();
            $("#addTargetTable").DataTable({
                data: resp['data'],
                "autoWidth": false,
                order: [[1,'asc']], 
                "language": {
                    "search": "Tìm kiếm ", 
                    "emptyTable": "Không có dữ liệu hiển thị", 
                    "info": "Hiển thị trang _PAGE_/_PAGES_", 
                    "infoEmpty": "Hiển thị trang 0/0", 
                    "lengthMenu": "Hiển thị _MENU_ hàng", 
                    "paginate": {
                      "previous": "Trang trước", 
                      'next': "Trang sau", 
                    },
                    select: {
                        rows: "Chọn %d mục tiêu"
                    }
                },
                rowId: '_id', 
                columns: [
                    {
                        data: null, 
                        defaultContent: '', 
                        className: 'select-checkbox', 
                        orderable: false
                    }, 
                    { data: "ip_address" },
                    { data: "name" }, 
                    {
                    className: "dt-center editor-delete",
                    defaultContent: '<button id="targetedit" class="btn btn-warning">Sửa</button><button id="targetdelete" class="btn btn-danger ml-3">Xóa</button>',
                    orderable: false
                    }
                ], 
                select:{
                    style: 'os', 
                    selector: 'td:first-child'
                }
                
            });
        }
    })
}

$("#processManagerTable").on("click",'#ViewResult', (e)=>{
    var table = $("#processManagerTable").DataTable(); 
    var row = $(e.currentTarget).closest('tr'); 
    var process_id = row.attr('id'); 
    if(table.row(row).data().Status == "StatusRunning"){
        swal({
            title: "Tiến trình đang chạy",
            text: "Vui lòng đợi đến khi kết thúc tiến trình để xem kết quả!",
            icon: "warning",
            button: "OK!",
          });
    }
    if(table.row(row).data().Status == "StatusSuccess"){
        $.ajax({
            type: "POST", 
            url : "/getmoduleprocessrun", 
            data: {"process_id": process_id},
            beforeSend: (request) =>{
              request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
            }
        })
        .done((resp) =>{
            if(resp['message'] == 'success'){
                var Module_list = resp['data']; 
                $("#ProcessResultModal").modal("show"); 
                if(Module_list.includes("Module_Input")){
                    $("#InputResultDiv").show();
                    $(".InputResult").attr("id", process_id); 
                }
                if(Module_list.includes("Module_Reconnaissance")){
                    $("#ReconResultDiv").show(); 
                    $(".ReconResult").attr("id", process_id); 
                }
                if(Module_list.includes("Module_Exploit")){
                    $("#ExploitResultDiv").show(); 
                    $(".ExploitResult").attr("id", process_id); 
                }
            }
        })
    } 
})

$(".ReconResult").on('click', function(){
    var process_id = $(this).attr('id'); 
    window.open("/recon#reconManagerTab~" + process_id); 
})
$(".InputResult").on('click', function(){
    var process_id = $(this).attr('id'); 
    window.open("/input#inputmanagertab~" + process_id);
})

$(".ExploitResult").on('click', function(){
    var process_id = $(this).attr('id'); 
    window.open("/exploit#exploitManagerTab~" + process_id); 
})


//---------------Cấu hình mục tiêu-----------------------------

function getAccountConfigData(){
    
    $.ajax({
        type: "GET", 
        url : "/getconfigdata", 
        beforeSend: (request) =>{
          request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
    })
    .done((resp)=>{
        if(resp['message'] == false){
            console.log(resp); 
            swal({
                title: "Chưa cấu hình cài đặt!",
                text: "Bạn hãy cấu hình server trước khi thực hiện kiểm thử!",
                icon: "error",
                buttons: true
              })
              .then((willDelete) => {
                if (willDelete) {
                  window.location.href = "/setting";  
                }
              });
        }
        if(resp['message'] == true){
            $("#AddtargetModal").modal('show');
        }

    })
    
}
$('#startButton').on('click', function(){
    getAccountConfigData();
}); 
$("#AddtargetModal").on('show.bs.modal', (e) => {
    redrawTargetModal(); 
 });
 $(".TargetManagerStart").on('click', '#targetdelete', function(e){
     var row = $(e.currentTarget).closest('tr'); 
     var targetid = row.attr('id'); 
     $.ajax({
         type: "DELETE", 
         url : "/deletetarget", 
         data : {"targetid":targetid}, 
         beforeSend: (request) =>{
         request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
         }
     })
     .done((resp) =>{
         if(resp['message'] == 'success'){
             $("#addTargetTable").DataTable().row(row).remove().draw();
         }
     })
 })
 $(".TargetManagerStart").on('click', '#targetedit', function(e){
     $("#AddtargetModal").modal('hide'); 
    var row = $(e.currentTarget).closest('tr'); 
    var targetid = row.attr('id'); 
    $.ajax({
    type: "POST", 
    url : "/gettarget", 
    data : {"id":targetid}, 
    beforeSend: (request) =>{
        request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
    }
    })
    .done((resp) =>{
        if(resp['message'] == 'success'){
            for(var [key,value] of Object.entries(resp['data'])){
                if(key == "authen"){
                    $("#username").val(value['username']); 
                }
                if(key == "describe"){
                    $("#targetDescription").val(value); 
                }
                if(key == "domain"){
                    $("#targetDomain").val(value); 
                }
                if(key == "ip_address"){
                    $("#targetIP").val(value);  
                }
                if(key == "name"){
                    $("#targetName").val(value); 
                }
            }
            $(".EditTargetStart").attr('id', targetid); 
            $("#EditTargetModal").modal('show'); 
        }
    })
     
 })
 $(".EditTargetStart").on('click', ()=>{
     var targetid = $(".EditTargetStart").attr('id'); 
     var targetName = $("#targetName").val(); 
     var targetIP = $("#targetIP").val(); 
     var targetDomain = $("#targetDomain").val(); 
     var targetDescription = $("#targetDescription").val(); 
     var username = $("#username").val(); 
     var password = $("#password").val();
     $.ajax({
        type: "POST", 
        url : "/updatetarget", 
        data : {"targetid":targetid, "targetName": targetName, "targetIP": targetIP, "targetDomain": targetDomain,"targetDescription": targetDescription, "username": username,"password": password}, 
        beforeSend: (request) =>{
            request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
        }
        })
        .done((resp) =>{
            if(resp['message'] == 'success'){
                new Noty({
                    type: 'success', 
                    layout: 'topRight',
                    theme: 'bootstrap-v4', 
                    text: 'Chỉnh sửa mục tiêu thành công!', 
                    timeout: 1500, 
                    progressBar: false,
                }).show();
                $("#EditTargetModal").modal("hide"); 
                $("#AddtargetModal").modal('show');
            }else{
                new Noty({
                    type: 'error', 
                    layout: 'topRight',
                    theme: 'bootstrap-v4', 
                    text: 'Có lỗi xảy ra, hãy thử lại!', 
                    timeout: 1500, 
                    progressBar: false,
                }).show();
            }
        })
     
      
 })
 $("#TargetSubmitStartModal").on('click', function(e){
     var TargetIPModal = $("#TargetIPModal").val(); 
     $("#TargetIPModal").val('');
     var TargetNameModal = $("#TargetNameModal").val(); 
     $("#TargetNameModal").val(''); 
     $.ajax({
         type: "POST", 
         url : "/addtarget", 
         data : {"targetIP":TargetIPModal, "targetname":TargetNameModal}, 
         beforeSend: (request) =>{
           request.setRequestHeader("X-CSRFToken", $('#csrf_token').val()); 
         }
     })
     .done((resp) =>{
         if(resp['data'] == "Update success"){
             redrawTargetModal();
         }
     })
 }); 
 $('#addTarget_next').on('click', function(){
     $("#AddtargetModal").modal('hide');
     $("#Tool_config").modal('show'); 
 }); 
 //----------------Cấu hình công cụ-----------------------------
 $("#Tool_config_next").on('click', function(){
     $("#Tool_config").modal('hide');
     $("#POC_config").modal('show');  
 }); 
 $("#tool_config_back").on('click', function(){
     $("#Tool_config").modal('hide');
     $("#AddtargetModal").modal('show');
 }); 
 //-----------------cấu hình POC--------------------------------
 $("#POC_Config_continue").on('click', function(){
     $("#POC_config").modal('hide');
     $("#Sumary").modal('show');
 }); 
 $("#poc_config_back").on("click", function(){
     $("#POC_config").modal('hide');
     $("#Tool_config").modal('show');
 }); 
 $("#authencheckbox").change(function(){
     if(this.checked){
         $(".accountdiv").show(); 
     }else{
         $(".accountdiv").hide(); 
     }
 });
 $("#autocheckbox").change(function(){
     if(this.checked){
         $(".custompocdiv").show();
     }else{
         $(".custompocdiv").hide();
     }
 })
 //----------------Cấu hình tổng hợp----------------------------
 $("#Scan").on('click', function(){
     $("#Sumary").modal('hide');
     alert('Quá trình scan bắt đầu, vui lòng đợi'); 
 }); 
 $("#sumary_back").on('click', function(){
     $("#Sumary").modal('hide');
     $("#POC_config").modal('show');
 }); 
 

